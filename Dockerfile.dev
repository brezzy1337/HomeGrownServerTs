FROM node:20.11-buster

# Alpine Linux CMD group
# RUN addgroup dev && addouser -S -G dev dev && apk add --no-cache make gcc g++ python3

# Debian CMD group
RUN addgroup dev && adduser --uid 1001 --ingroup dev --shell /bin/bash --disabled-password --gecos "" dev

WORKDIR /app

RUN chown dev:dev /app

USER dev

COPY package*.json ./

RUN npm i node-pre-gyp && npm ci

COPY . .

ENV PORT=8080

EXPOSE 8080

CMD ["sh", "-c", "until nc -z postgres 5432; do sleep 1; done; npm run prisma generate && npm run prisma migrate && npm run start:dev" ]

